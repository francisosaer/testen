<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Opmeet Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
html { font-size:30px; }
body { font-family: Arial, sans-serif; background:#f4f6f8; max-width:1100px; margin:auto; padding:16px; }
h1 { text-align:center; font-size:2.6rem; }

.card, .element { background:#fff; border-radius:14px; padding:18px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,.15); }
label { font-weight:bold; display:block; margin-top:14px; }
input, select { width:100%; font-size:1.6rem; padding:14px; margin-top:6px; }

.element-header { display:flex; justify-content:space-between; align-items:center; }
.remove-element { width:40px; height:40px; background:red; color:white; font-weight:bold; font-size:22px; border:none; display:flex; align-items:center; justify-content:center; border-radius:4px; cursor:pointer; }

.photo-box { margin-top:16px; padding:16px; border:3px dashed #bbb; border-radius:14px; text-align:center; }
.camera-btn { font-size:90px; cursor:pointer; }

.photo-wrapper { position:relative; margin-top:14px; display:inline-block; }
.photo-wrapper img { width:100%; border-radius:10px; display:block; }
.remove-photo {
  position:absolute;
  top:4px;
  right:4px;
  width:32px;
  height:32px;
  background:red;
  color:white;
  font-weight:bold;
  font-size:20px;
  border:none;
  border-radius:4px;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,0.3);
  z-index:10;
}

button { width:100%; padding:20px; font-size:1.8rem; border:none; border-radius:14px; margin-top:10px; cursor:pointer; }
.primary { background:#2c7be5; color:white; }
.add-options { display:flex; gap:10px; }
.add-options button { flex:1; }
.actions { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
.new-project { background:green; color:white; font-weight:bold; font-size:24px; }

@media(max-width:700px){
  html { font-size:32px; }
  .camera-btn { font-size:100px; }
  button { font-size:2rem; }
}
</style>
</head>
<body>

<h1>Opmeet Tool</h1>

<div class="card">
  <label>Klantnaam</label>
  <input id="clientName">
  <label>Datum</label>
  <input type="date" id="projectDate">
  <label>Klantenhistoriek</label>
  <select id="clientHistory">
    <option value="">-- Kies klant --</option>
  </select>
</div>

<button id="addBtn" class="primary">+ Element toevoegen</button>
<div class="add-options" id="options" style="display:none">
  <button data-type="Raam">Raam</button>
  <button data-type="Deur">Deur</button>
  <button data-type="Poort">Poort</button>
</div>

<div id="elements"></div>

<div class="card actions">
  <button onclick="exportPDF()">ðŸ“„ PDF</button>
  <button onclick="mailPDF()">ðŸ“§ Mail PDF</button>
  <button class="new-project" onclick="newProject()">âž• Nieuw project</button>
</div>

<script>
const container = document.getElementById("elements");
const counters = {Raam:0, Deur:0, Poort:0};
const clientName = document.getElementById("clientName");
const projectDate = document.getElementById("projectDate");
const options = document.getElementById("options");
const clientHistory = document.getElementById("clientHistory");

document.getElementById("addBtn").onclick = () => {
  options.style.display = options.style.display === "flex" ? "none" : "flex";
};
document.querySelectorAll("#options button").forEach(b=>{
  b.onclick = ()=> addElement(b.dataset.type);
});

function addElement(type){
  counters[type]++;
  const el = document.createElement("div");
  el.className="element";
  el.innerHTML=`
    <div class="element-header">
      <strong>${type} ${counters[type]}</strong>
      <button class="remove-element">âœ–</button>
    </div>
    <label>Breedte (cm)</label><input type="number">
    <label>Hoogte (cm)</label><input type="number">
    <div class="photo-box">
      <div class="camera-btn">ðŸ“·</div>
      <input type="file" accept="image/*" capture="environment" hidden>
      <div class="photos"></div>
    </div>
  `;
  container.appendChild(el);
  el.scrollIntoView({behavior:"smooth"});

  el.querySelector(".remove-element").onclick=()=>{
    el.remove();
    renumberElements();
    autosave();
  };

  el.querySelectorAll("input[type=number]").forEach(i=> i.oninput=autosave);

  const cam = el.querySelector(".camera-btn");
  const file = el.querySelector("input[type=file]");
  const photos = el.querySelector(".photos");
  cam.onclick=()=>file.click();
  file.onchange=()=>{
    const r = new FileReader();
    r.onload=e=>{
      const img = new Image();
      img.onload=()=>{
        const c = document.createElement("canvas");
        const s = Math.min(800/img.width,1);
        c.width = img.width*s; c.height = img.height*s;
        c.getContext("2d").drawImage(img,0,0,c.width,c.height);
        const wrap = document.createElement("div");
        wrap.className="photo-wrapper";
        wrap.innerHTML=`<img src="${c.toDataURL("image/jpeg",0.6)}"><button class="remove-photo">âœ–</button>`;
        wrap.querySelector("button").onclick=()=>{ wrap.remove(); autosave();}
        photos.appendChild(wrap);
        autosave();
      }
      img.src=e.target.result;
    };
    r.readAsDataURL(file.files[0]);
  };
  autosave();
}

// Automatische hernummering
function renumberElements(){
  const types = ["Raam","Deur","Poort"];
  types.forEach(type=>{
    let count = 0;
    container.querySelectorAll(".element").forEach(el=>{
      const strong = el.querySelector("strong");
      if(strong.textContent.startsWith(type)){
        count++;
        strong.textContent = `${type} ${count}`;
      }
    });
    counters[type] = count;
  });
}

// Autosave + max 20 klanten
function autosave(){
  const data={klant:clientName.value, datum:projectDate.value, elementen:[]};
  container.querySelectorAll(".element").forEach(el=>{
    data.elementen.push({
      titel: el.querySelector("strong").innerText,
      b: el.querySelectorAll("input[type=number]")[0].value,
      h: el.querySelectorAll("input[type=number]")[1].value,
      fotos:[...el.querySelectorAll("img")].map(i=>i.src)
    });
  });

  if(clientName.value) localStorage.setItem(clientName.value, JSON.stringify(data));
  localStorage.setItem("autosave", JSON.stringify(data));

  updateClientHistory();
}

function restore(){
  const s = localStorage.getItem("autosave");
  if(!s) return;
  const d = JSON.parse(s);
  clientName.value = d.klant;
  projectDate.value = d.datum;
  d.elementen.forEach(e=>{
    addElement(e.titel.split(" ")[0]);
    const el = container.lastChild;
    el.querySelectorAll("input[type=number]")[0].value = e.b;
    el.querySelectorAll("input[type=number]")[1].value = e.h;
    const p = el.querySelector(".photos");
    e.fotos.forEach(src=>{
      const w = document.createElement("div");
      w.className="photo-wrapper";
      w.innerHTML=`<img src="${src}"><button class="remove-photo">âœ–</button>`;
      w.querySelector("button").onclick=()=>{ w.remove(); autosave();}
      p.appendChild(w);
    });
  });
  renumberElements();
}

// Max 20 klanten
function updateClientHistory(){
  const keys = [];
  for (let i=0;i<localStorage.length;i++){
    const key = localStorage.key(i);
    if(key === "autosave") continue;
    keys.push(key);
  }
  keys.sort(); // oudste eerst
  while(keys.length>20){
    const oldest = keys.shift();
    localStorage.removeItem(oldest);
  }
  const sel = clientHistory;
  sel.innerHTML = '<option value="">-- Kies klant --</option>';
  keys.forEach(k=> sel.innerHTML += `<option value="${k}">${k}</option>`);
}

clientHistory.onchange = e=>{
  const name = e.target.value;
  if(!name) return;
  const data = JSON.parse(localStorage.getItem(name));
  if(!data) return alert("Niet gevonden");
  container.innerHTML="";
  clientName.value=data.klant;
  projectDate.value=data.datum;
  data.elementen.forEach(e=>{
    addElement(e.titel.split(" ")[0]);
    const el = container.lastChild;
    el.querySelectorAll("input[type=number]")[0].value = e.b;
    el.querySelectorAll("input[type=number]")[1].value = e.h;
    const p = el.querySelector(".photos");
    e.fotos.forEach(src=>{
      const w = document.createElement("div");
      w.className="photo-wrapper";
      w.innerHTML=`<img src="${src}"><button class="remove-photo">âœ–</button>`;
      w.querySelector("button").onclick=()=>{ w.remove(); autosave();}
      p.appendChild(w);
    });
  });
  renumberElements();
}

function newProject(){
  if(confirm("Nieuw project starten?")){
    localStorage.removeItem("autosave");
    location.reload();
  }
}

function exportPDF(){
  const {jsPDF} = window.jspdf;
  const pdf = new jsPDF();
  let y=10;
  pdf.setFontSize(16);
  pdf.text("Opmeetrapport",10,y); y+=10;
  pdf.setFontSize(12);
  pdf.text(`Klant: ${clientName.value}`,10,y); y+=8;
  pdf.text(`Datum: ${projectDate.value}`,10,y); y+=10;
  container.querySelectorAll(".element").forEach(el=>{
    pdf.text(el.querySelector("strong").innerText,10,y); y+=6;
    [...el.querySelectorAll("img")].forEach(img=>{
      pdf.addImage(img.src,"JPEG",10,y,50,35); y+=40;
    });
  });
  pdf.save("opmeting.pdf");
}

function mailPDF(){
  exportPDF();
  alert("PDF is gedownload. Voeg deze toe in je e-mail client om te versturen.");
}

restore();
updateClientHistory();
</script>

</body>
</html>
