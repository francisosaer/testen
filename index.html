<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nieuwe Opmeting</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  margin:0;
  padding:15px;
  background:#f4f6f8;
}

header{text-align:center;margin-bottom:10px;}
header img{max-width:60px;display:block;margin:0 auto 5px auto;}
h1{font-size:24px;margin:0 0 10px 0;color:rgb(15,36,65);}

button{
  padding:6px 12px;
  margin:5px 2px;
  border:none;
  border-radius:5px;
  background:rgb(15,36,65);
  color:white;
  cursor:pointer;
  font-size:14px;
}

button:hover:enabled{opacity:0.9;}
button:disabled{background:#999;}

select,input,textarea{
  width:100%;
  padding:6px;
  margin:5px 0;
  border-radius:5px;
  border:1px solid #ccc;
}

.element{
  position:relative;
  background:white;
  padding:12px;
  margin-top:15px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.08);
  border-left:6px solid rgb(15,36,65);
}

.raam{border-left-color:#2980b9;}
.deur{border-left-color:#27ae60;}
.poort{border-left-color:#8e44ad;}

.verwijder-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:#c0392b;
  font-size:12px;
  padding:5px 8px;
}

.photos{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:10px;
}

.photos img{
  width:90px;
  border-radius:6px;
  border:1px solid #ccc;
}

/* ================= CAMERA ================= */

#cameraModal{
  display:none;
  position:fixed;
  top:0;left:0;
  width:100vw;
  height:calc(var(--vh) * 100);
  background:black;
  z-index:1000;
  overflow:hidden;
}

#cameraModal video{
  position:absolute;
  top:0;left:0;
  width:100%;
  height:100%;
  object-fit:cover;
}

#closeCameraBtn{
  position:absolute;
  top:20px;
  right:20px;
  background:rgba(0,0,0,0.5);
  border:none;
  color:white;
  font-size:18px;
  padding:8px 12px;
  border-radius:8px;
  cursor:pointer;
}

#cameraOverlay{
  position:absolute;
  bottom:0;
  left:0;
  width:100%;
  height:140px;
  background:linear-gradient(to top, rgba(0,0,0,0.8), transparent);
  display:flex;
  justify-content:center;
  align-items:center;
}

#takePhotoBtn{
  width:75px;
  height:75px;
  border-radius:50%;
  border:6px solid white;
  background:white;
  cursor:pointer;
}

#takePhotoBtn:active{
  transform:scale(0.92);
}
</style>
</head>

<body>

<header>
<img src="Logordb.png">
<h1>Nieuwe Opmeting</h1>
<button onclick="nieuwProject()">Nieuw Project</button>
</header>

<input type="text" id="klant" placeholder="Naam klant">

<h3>Kamer</h3>
<select id="kamer">
<option>Slaapkamer 1</option>
<option>Slaapkamer 2</option>
<option>Keuken</option>
<option>Eetplaats</option>
<option>Living</option>
<option>Gang</option>
<option>Toilet</option>
<option>Badkamer</option>
<option>Garage</option>
</select>

<h3>Element</h3>
<select id="elementType">
<option value="Raam">Raam</option>
<option value="Deur">Deur</option>
<option value="Poort">Poort</option>
</select>

<button onclick="voegElementToe()">Toevoegen</button>

<div id="lijst"></div>

<!-- CAMERA -->
<div id="cameraModal">
  <video id="video" autoplay playsinline></video>
  <button id="closeCameraBtn" onclick="closeCamera()">âœ•</button>
  <div id="cameraOverlay">
      <button id="takePhotoBtn" onclick="takePhoto()"></button>
  </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>

/* ===== Fix mobiele viewport ===== */
function setRealViewportHeight(){
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
window.addEventListener('resize', setRealViewportHeight);
window.addEventListener('load', setRealViewportHeight);

/* ===== DATA ===== */
let project = {klant:"",elementen:[]};
let fotosMemory = {};
let currentElementId=null;

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const cameraModal=document.getElementById("cameraModal");

/* ===== HERNUMMERING ===== */
function hernummerElementen(){
  const types=["Raam","Deur","Poort"];

  types.forEach(type=>{
    let teller=1;

    project.elementen
      .filter(el=>el.type===type)
      .forEach(el=>{
        el.nummer=teller;
        teller++;
      });
  });
}

/* ===== FUNCTIES ===== */

function nieuwProject(){
  if(confirm("Nieuw project starten?")){
    location.reload();
  }
}

function voegElementToe(){
  const type=document.getElementById("elementType").value;
  const kamer=document.getElementById("kamer").value;

  const nieuw={
    id:Date.now(),
    type:type,
    nummer:0,
    kamer:kamer,
    breedte:"",
    hoogte:"",
    notitie:""
  };

  project.elementen.push(nieuw);
  fotosMemory[nieuw.id]=[];

  hernummerElementen();
  render();
}

function verwijder(id){
  project.elementen = project.elementen.filter(e=>e.id!==id);
  delete fotosMemory[id];

  hernummerElementen();
  render();
}

function render(){
  const lijst=document.getElementById("lijst");
  lijst.innerHTML="";

  project.elementen.forEach(el=>{
    const div=document.createElement("div");

    let kleurClass="";
    if(el.type==="Raam") kleurClass="raam";
    if(el.type==="Deur") kleurClass="deur";
    if(el.type==="Poort") kleurClass="poort";

    div.className="element "+kleurClass;

    div.innerHTML=`
      <button class="verwijder-btn" onclick="verwijder(${el.id})">X</button>
      <strong>${el.type} ${el.nummer} - ${el.kamer}</strong>
      <input placeholder="Breedte cm">
      <input placeholder="Hoogte cm">
      <textarea placeholder="Notitie"></textarea>
      <button onclick="openCamera(${el.id})">Foto nemen</button>
      <div class="photos">
      ${fotosMemory[el.id].map(f=>`<img src="${f}">`).join("")}
      </div>
    `;

    lijst.appendChild(div);
  });
}

/* ===== CAMERA ===== */

async function openCamera(id){
  currentElementId=id;
  cameraModal.style.display="block";

  try{
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"}}
    });
    video.srcObject=stream;
  }catch(e){
    alert("Camera niet beschikbaar");
  }
}

function takePhoto(){
  const ctx=canvas.getContext("2d");
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  ctx.drawImage(video,0,0);

  const data=canvas.toDataURL("image/jpeg",0.6);
  fotosMemory[currentElementId].push(data);

  closeCamera();
  render();
}

function closeCamera(){
  cameraModal.style.display="none";
  if(video.srcObject){
    video.srcObject.getTracks().forEach(track=>track.stop());
  }
}

render();

</script>
</body>
</html>
