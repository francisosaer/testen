<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Nieuwe Opmeting</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family: Arial, sans-serif;
    margin:0;
    padding:15px;
    background:#f4f6f8;
}

h1{
    text-align:center;
    color:rgba(15,36,65);
    margin-bottom:5px;
}

button{
    padding:8px 14px;
    margin:5px 0;
    border:none;
    border-radius:6px;
    background:rgba(15,36,65);
    color:white;
    cursor:pointer;
    font-size:14px;
}

button:hover{
    opacity:0.9;
}

select,input,textarea{
    width:100%;
    padding:6px;
    margin:5px 0;
    border-radius:5px;
    border:1px solid #ccc;
    font-size:14px;
}

.element{
    background:white;
    padding:12px;
    margin-top:15px;
    border-radius:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.1);
    border-left:5px solid rgba(15,36,65);
}

.photos{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:10px;
}

.photos img{
    width:100px;
    height:auto;
    border-radius:6px;
    object-fit:cover;
}

canvas{
    display:none;
}

#cameraModal{
    display:none;
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:black;
    justify-content:center;
    align-items:center;
    flex-direction:column;
}

#cameraModal video{
    width:100%;
    max-height:70%;
}

</style>
</head>

<body>

<h1>Nieuwe Opmeting</h1>

<button onclick="nieuwProject()">Nieuw Project</button>

<input type="text" id="klant" placeholder="Naam klant">

<h3>Kamer kiezen</h3>
<select id="kamer">
    <option>Slaapkamer 1</option>
    <option>Slaapkamer 2</option>
    <option>Keuken</option>
    <option>Eetplaats</option>
    <option>Living</option>
    <option>Gang</option>
    <option>Toilet</option>
    <option>Badkamer</option>
    <option>Garage</option>
</select>

<h3>Kies element</h3>
<select id="elementType">
    <option value="Raam">Raam</option>
    <option value="Deur">Deur</option>
    <option value="Poort">Poort</option>
</select>

<button onclick="voegElementToe()">Toevoegen</button>

<div id="lijst"></div>

<button onclick="maakPDF()">Project als PDF</button>

<!-- CAMERA -->
<div id="cameraModal">
    <video id="video" autoplay playsinline></video>
    <button onclick="takePhoto()">Foto maken</button>
    <button onclick="closeCamera()">Sluiten</button>
</div>

<canvas id="canvas"></canvas>

<script>
let project = JSON.parse(localStorage.getItem("project")) || {
    klant:"",
    elementen:[],
    teller:{Raam:0,Deur:0,Poort:0}
};

let currentElementId=null;
let stream=null;

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const cameraModal=document.getElementById("cameraModal");

function save(){
    localStorage.setItem("project",JSON.stringify(project));
}

function nieuwProject(){
    if(confirm("Nieuw project starten? Alles wordt gewist.")){
        localStorage.removeItem("project");
        location.reload();
    }
}

function voegElementToe(){
    const type=document.getElementById("elementType").value;
    const kamer=document.getElementById("kamer").value;

    project.teller[type]++;

    const nieuw={
        id:Date.now(),
        type:type,
        nummer:project.teller[type],
        kamer:kamer,
        breedte:"",
        hoogte:"",
        notitie:"",
        fotos:[]
    };

    project.elementen.unshift(nieuw);
    save();
    render();
}

function render(){
    document.getElementById("klant").value=project.klant;

    const lijst=document.getElementById("lijst");
    lijst.innerHTML="";

    project.elementen.forEach(el=>{
        const div=document.createElement("div");
        div.className="element";

        div.innerHTML=`
        <strong>${el.type} ${el.nummer} - ${el.kamer}</strong>
        <br>
        Breedte (cm):
        <input value="${el.breedte}" onchange="update(${el.id},'breedte',this.value)">
        Hoogte (cm):
        <input value="${el.hoogte}" onchange="update(${el.id},'hoogte',this.value)">
        Notitie:
        <textarea onchange="update(${el.id},'notitie',this.value)">${el.notitie}</textarea>
        <button onclick="openCamera(${el.id})">Foto nemen</button>
        <button onclick="verwijder(${el.id})">Verwijderen</button>
        <div class="photos">
        ${el.fotos.map((f,i)=>`
            <div>
                <img src="${f}">
                <button onclick="verwijderFoto(${el.id},${i})">X</button>
            </div>
        `).join("")}
        </div>
        `;

        lijst.appendChild(div);
    });
}

function update(id,veld,waarde){
    const el=project.elementen.find(e=>e.id===id);
    el[veld]=waarde;
    save();
}

function verwijder(id){
    project.elementen=project.elementen.filter(e=>e.id!==id);
    save();
    render();
}

function verwijderFoto(id,index){
    const el=project.elementen.find(e=>e.id===id);
    el.fotos.splice(index,1);
    save();
    render();
}

async function openCamera(id){
    currentElementId=id;
    cameraModal.style.display="flex";

    try{
        stream=await navigator.mediaDevices.getUserMedia({
            video:{facingMode:{ideal:"environment"}}
        });

        video.srcObject=stream;
    }catch(err){
        alert("Camera niet beschikbaar");
    }
}

function takePhoto(){
    const context=canvas.getContext("2d");
    canvas.width=video.videoWidth;
    canvas.height=video.videoHeight;

    context.drawImage(video,0,0);

    const data=canvas.toDataURL("image/jpeg",0.6);

    const el=project.elementen.find(e=>e.id===currentElementId);
    el.fotos.push(data);

    save();
    render();
    closeCamera();
}

function closeCamera(){
    cameraModal.style.display="none";
    if(stream){
        stream.getTracks().forEach(track=>track.stop());
    }
}

async function maakPDF(){
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();

    let y=10;

    doc.text("Nieuwe Opmeting",10,y);
    y+=10;

    doc.text("Klant: "+document.getElementById("klant").value,10,y);
    y+=10;

    for(const el of project.elementen){

        doc.text(`${el.type} ${el.nummer} - ${el.kamer}`,10,y);
        y+=7;

        doc.text(`Breedte: ${el.breedte} cm`,10,y);
        y+=7;

        doc.text(`Hoogte: ${el.hoogte} cm`,10,y);
        y+=7;

        if(el.notitie){
            doc.text(`Notitie: ${el.notitie}`,10,y);
            y+=7;
        }

        for(const foto of el.fotos){
            if(y>240){
                doc.addPage();
                y=10;
            }

            doc.addImage(foto,"JPEG",10,y,50,40);
            y+=45;
        }

        y+=5;
    }

    doc.save("Opmeting.pdf");
}

render();
</script>

</body>
</html>


