<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Opmeet Tool</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c7be5">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
html { font-size:32px; }
body { font-family: Arial,sans-serif; background:#f4f6f8; max-width:1100px; margin:auto; padding:16px; }
h1 { text-align:center; font-size:2.4rem; }
.card, .element { background:#fff; border-radius:14px; padding:18px; margin-bottom:20px; box-shadow:0 4px 10px rgba(0,0,0,.15); }
label { font-weight:bold; margin-top:14px; display:block; }
input { width:100%; padding:18px; font-size:1.4rem; margin-top:6px; }
button { width:100%; padding:18px; font-size:1.6rem; border:none; border-radius:14px; cursor:pointer; }
.primary { background:#2c7be5; color:white; }
.add-options { display:none; gap:10px; margin-top:10px; }
.add-options button { flex:1; }
.element-header { display:flex; justify-content:space-between; align-items:center; }
.remove-btn { background:none; border:none; font-size:1.8rem; cursor:pointer; }
.photo-box { border:3px dashed #bbb; border-radius:14px; padding:16px; text-align:center; margin-top:14px; }
.camera-btn { font-size:90px; cursor:pointer; }
.photo-wrapper { position:relative; margin-top:12px; }
.photo-wrapper img { width:100%; border-radius:10px; }
.remove-photo { position:absolute; top:8px; right:8px; background:rgba(220,0,0,.9); color:white; border:none; border-radius:50%; width:34px; height:34px; font-size:18px; }
</style>
</head>
<body>

<h1>Opmeet Tool</h1>

<div class="card">
  <label>Klantnaam</label>
  <input id="clientName">
  <label>Datum</label>
  <input type="date" id="projectDate">
</div>

<button id="addBtn" class="primary">+ Element toevoegen</button>

<div class="add-options" id="typeOptions">
  <button data-type="Raam">Raam</button>
  <button data-type="Deur">Deur</button>
  <button data-type="Poort">Poort</button>
</div>

<div id="elements"></div>

<button id="exportPDF" class="primary">üìÑ PDF maken</button>

<script>
const container = document.getElementById("elements");
const addBtn = document.getElementById("addBtn");
const typeOptions = document.getElementById("typeOptions");
const clientName = document.getElementById("clientName");
const projectDate = document.getElementById("projectDate");

let counters = {Raam:0, Deur:0, Poort:0};
let isDirty = false;

addBtn.onclick = ()=>typeOptions.style.display = typeOptions.style.display==="flex"?"none":"flex";

typeOptions.querySelectorAll("button").forEach(btn=>{
  btn.onclick=()=>{
    addElement(btn.dataset.type);
    typeOptions.style.display="none";
    save();
  }
});

function addElement(type, data=null){
  counters[type]++;

  const el = document.createElement("div");
  el.className="element";

  el.innerHTML = `
    <div class="element-header">
      <strong>${type} ${counters[type]}</strong>
      <button class="remove-btn">üóëÔ∏è</button>
    </div>
    <label>Breedte (cm)</label>
    <input type="number" value="${data?.breedte||''}">
    <label>Hoogte (cm)</label>
    <input type="number" value="${data?.hoogte||''}">
    <div class="photo-box">
      <div class="camera-btn">üì∑</div>
      <input type="file" accept="image/*" capture="environment" hidden>
      <div class="photos"></div>
    </div>
  `;
  container.appendChild(el);

  el.querySelector(".remove-btn").onclick=()=>{el.remove(); save();};
  el.querySelectorAll("input").forEach(i=>{
    i.oninput=()=>{save(); isDirty=true;};
  });

  const cam = el.querySelector(".camera-btn");
  const fileInput = el.querySelector("input[type=file]");
  const photos = el.querySelector(".photos");

  cam.onclick=()=>fileInput.click();

  fileInput.onchange=()=>{
    const f=fileInput.files[0]; if(!f) return;

    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const MAX_WIDTH=800;
        const scale=Math.min(1, MAX_WIDTH/img.width);
        canvas.width = img.width*scale;
        canvas.height = img.height*scale;
        canvas.getContext("2d").drawImage(img,0,0,canvas.width,canvas.height);
        let compressed = canvas.toDataURL("image/jpeg",0.6);

        const wrap=document.createElement("div");
        wrap.className="photo-wrapper";

        const imgEl=document.createElement("img");
        imgEl.src=compressed;

        const del=document.createElement("button");
        del.className="remove-photo"; del.textContent="‚úñ";
        del.onclick=()=>{wrap.remove(); save();};

        wrap.appendChild(imgEl);
        wrap.appendChild(del);
        photos.appendChild(wrap);
        save();
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(f);
  };

  if(data?.fotos){
    data.fotos.forEach(src=>{
      const wrap=document.createElement("div");
      wrap.className="photo-wrapper";
      wrap.innerHTML=`<img src="${src}"><button class="remove-photo">‚úñ</button>`;
      wrap.querySelector("button").onclick=()=>{wrap.remove(); save();};
      photos.appendChild(wrap);
    });
  }
}

function save(){
  const data={klant: clientName.value, datum: projectDate.value, elementen:[]};
  document.querySelectorAll(".element").forEach(el=>{
    data.elementen.push({
      type: el.querySelector("strong").textContent,
      breedte: el.querySelectorAll("input")[0].value,
      hoogte: el.querySelectorAll("input")[1].value,
      fotos:[...el.querySelectorAll("img")].map(i=>i.src)
    });
  });
  localStorage.setItem("opmeetProject",JSON.stringify(data));
}

window.onload=()=>{
  const saved=localStorage.getItem("opmeetProject");
  if(!saved) return;
  const data=JSON.parse(saved);
  clientName.value=data.klant;
  projectDate.value=data.datum;
  data.elementen.forEach(e=>addElement(e.type.split(" ")[0],e));
};

// ----------------- Waarschuwing bij refresh -----------------
window.addEventListener("beforeunload", function (e) {
  if(!isDirty) return undefined;
  const confirmationMessage="Weet je zeker dat je de pagina wilt vernieuwen? Alle niet-opgeslagen gegevens kunnen verloren gaan.";
  (e || window.event).returnValue = confirmationMessage;
  return confirmationMessage;
});

// PDF export
document.getElementById("exportPDF").onclick=()=>{
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  const saved=localStorage.getItem("opmeetProject"); if(!saved) return;
  const data=JSON.parse(saved);

  let y=20;
  doc.setFontSize(16);
  doc.text(`Klant: ${data.klant}`,10,y); y+=10;
  doc.text(`Datum: ${data.datum}`,10,y); y+=10;

  data.elementen.forEach(el=>{
    doc.text(`${el.type}`,10,y); y+=10;
    doc.text(`Breedte: ${el.breedte} cm`,10,y); y+=10;
    doc.text(`Hoogte: ${el.hoogte} cm`,10,y); y+=10;
  });
  doc.save(`opmeting_${data.klant||'project'}.pdf`);
};

// PWA service worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>

