<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nieuwe Opmeting</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:0;padding:15px;background:#f4f6f8;}
header{text-align:center;margin-bottom:10px;}
header img{max-width:50px;display:block;margin:0 auto 5px auto;}
h1{font-size:24px;margin:0 0 10px 0;color:rgb(15,36,65);}
button{padding:6px 12px;margin:5px 2px;border:none;border-radius:5px;background:rgb(15,36,65);color:white;cursor:pointer;font-size:14px;}
button:hover:enabled{opacity:0.9;} button:disabled{background:#999;cursor:not-allowed;}
select,input,textarea{width:100%;padding:6px;margin:5px 0;border-radius:5px;border:1px solid #ccc;}
.element{position:relative;background:white;padding:12px;margin-top:15px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.08);border-left:6px solid rgb(15,36,65);}
.raam{border-left-color:#2980b9;} .deur{border-left-color:#27ae60;} .poort{border-left-color:#8e44ad;}
.verwijder-btn{position:absolute;top:10px;right:10px;background:#c0392b;font-size:12px;padding:5px 8px;}
.photos{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
.photos img{width:90px;border-radius:6px;border:1px solid #ccc;}
#cameraModal{display:none;position:fixed;top:0;left:0;width:100vw;height:calc(var(--vh)*100);background:rgba(0,0,0,0.95);z-index:1000;overflow:hidden;}
#cameraModal video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}
#cameraModal button{position:absolute;z-index:1010;padding:12px 18px;border-radius:6px;border:none;background:rgba(15,36,65,0.85);color:white;font-size:16px;}
#takePhotoBtn{bottom:30px;left:50%;transform:translateX(-50%);}
#closeCameraBtn{top:20px;right:20px;}
</style>
</head>
<body>

<header>
<img src="Logordb.png" alt="Logo">
<h1>Nieuwe Opmeting</h1>
<button onclick="nieuwProject()">Nieuw Project</button>
</header>

<input type="text" id="klant" placeholder="Naam klant">

<h3>Kamer kiezen</h3>
<select id="kamer">
<option>Slaapkamer</option>
<option>Badkamer</option>
<option>Keuken</option>
<option>Living</option>
<option>Garage</option>
<option>Eetplaats</option>
<option>Gang</option>
<option>Toilet</option>
<option>Ander</option>
</select>

<h3>Kies element</h3>
<select id="elementType">
<option value="Raam">Raam</option>
<option value="Deur">Deur</option>
<option value="Poort">Poort</option>
</select>

<button onclick="voegElementToe()">Toevoegen</button>

<div id="lijst"></div>

<button onclick="maakPDF()">Project als PDF</button>
<button id="mailBtn" onclick="mailProject()" disabled>Project mailen</button>

<p id="mailInstructie" style="display:none;">Open het gedownloade PDF-bestand via je bestanden-app om het bij te voegen in Mail.</p>

<!-- CAMERA -->
<div id="cameraModal">
<video id="video" autoplay playsinline></video>
<button id="takePhotoBtn" onclick="takePhoto()">Foto maken</button>
<button id="closeCameraBtn" onclick="closeCamera()">Sluiten</button>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
function setRealViewportHeight(){ const vh = window.innerHeight*0.01; document.documentElement.style.setProperty('--vh',`${vh}px`);}
window.addEventListener('resize',setRealViewportHeight);
window.addEventListener('load',setRealViewportHeight);

let project = JSON.parse(localStorage.getItem("project"))||{klant:"",elementen:[]};
let fotosMemory = {};
let currentElementId = null;
let pdfGemaakt = false;

function saveMetadata(){ localStorage.setItem("project",JSON.stringify(project)); }
function nieuwProject(){ if(confirm("Nieuw project starten? Alles wordt gewist.")){ localStorage.removeItem("project"); location.reload(); }}
function voegElementToe(){
    const type=document.getElementById("elementType").value;
    const kamer=document.getElementById("kamer").value;
    const nieuw={id:Date.now(),type:type,kamer:kamer,breedte:"",hoogte:"",notitie:""};
    project.elementen.unshift(nieuw);
    fotosMemory[nieuw.id]=[];
    saveMetadata();
    render();
}

function render(){
    document.getElementById("klant").value=project.klant;
    const lijst=document.getElementById("lijst");
    lijst.innerHTML="";
    let typeCount={Raam:0,Deur:0,Poort:0};
    let nummering={};
    const reversed=[...project.elementen].reverse();
    reversed.forEach(el=>{ typeCount[el.type]++; nummering[el.id]=typeCount[el.type]; });

    project.elementen.forEach(el=>{
        const nummer=nummering[el.id];
        if(!fotosMemory[el.id]) fotosMemory[el.id]=[];
        const div=document.createElement("div");
        div.className="element";
        div.innerHTML=`
            <button class="verwijder-btn" onclick="verwijderElement(${el.id})">Element verwijderen</button>
            <strong>${el.type} ${nummer} - ${el.kamer}</strong><br>
            Breedte (cm):
            <input value="${el.breedte}" onchange="update(${el.id},'breedte',this.value)">
            Hoogte (cm):
            <input value="${el.hoogte}" onchange="update(${el.id},'hoogte',this.value)">
            Notitie:
            <textarea onchange="update(${el.id},'notitie',this.value)">${el.notitie}</textarea>
            <button onclick="openCamera(${el.id})">Foto nemen</button>
            <div class="photos">
                ${fotosMemory[el.id].map((f,i)=>`
                    <div style="position:relative;">
                        <img src="${f}">
                        <button style="position:absolute;top:-6px;right:-6px;background:#2980b9;border:none;color:white;font-size:12px;width:20px;height:20px;border-radius:50%;cursor:pointer;" onclick="verwijderFoto(${el.id},${i})">Ã—</button>
                    </div>
                `).join("")}
            </div>
        `;
        lijst.appendChild(div);
    });
}

function update(id,veld,waarde){ const el=project.elementen.find(e=>e.id===id); el[veld]=waarde; saveMetadata();}
function verwijderFoto(id,index){ fotosMemory[id].splice(index,1); render();}
function verwijderElement(id){ if(confirm("Element verwijderen?")){ project.elementen=project.elementen.filter(e=>e.id!==id); delete fotosMemory[id]; saveMetadata(); render();}}

async function openCamera(id){ currentElementId=id; cameraModal.style.display="block"; try{ const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"}}}); video.srcObject=stream;}catch(err){alert("Camera niet beschikbaar");}}
function takePhoto(){ const ctx=canvas.getContext("2d"); canvas.width=video.videoWidth; canvas.height=video.videoHeight; ctx.drawImage(video,0,0); const data=canvas.toDataURL("image/jpeg",0.6); fotosMemory[currentElementId].push(data); closeCamera(); setTimeout(render,150);}
function closeCamera(){ cameraModal.style.display="none"; if(video.srcObject) video.srcObject.getTracks().forEach(track=>track.stop());}

/* ===== PDF functie volledig aangepast ===== */
function loadImagePromise(src){return new Promise(resolve=>{const img=new Image();img.src=src;img.onload=()=>resolve(img);});}

async function maakPDF(){
    if(!project.klant){alert("Geef eerst de naam van de klant in."); return;}
    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();

    // Coverpagina
    const logo = await loadImagePromise('Logordb.png');
    const maxLogoW=40,maxLogoH=40;
    let w=maxLogoW,h=maxLogoH;
    const ratio=logo.width/logo.height;
    if(ratio>1){h=maxLogoW/ratio;}else{w=maxLogoH*ratio;}
    doc.addImage(logo,'PNG',15,15,w,h);

    // Tekst cover
    doc.setFontSize(12); doc.setTextColor(0);
    doc.text("Ramen en deuren in hout / pvc / aluminium", 60,25);
    doc.text("Rolluiken",60,32);
    doc.text("Zonwering",60,39);
    doc.text("Garagepoorten",60,46);

    doc.setFontSize(20); doc.text("Nieuwe Opmeting",105,70,{align:"center"});
    doc.setFontSize(16); doc.text(`${project.klant}`,105,80,{align:"center"});
    doc.setFontSize(14); doc.text("Overzicht aantal elementen",105,90,{align:"center"});

    // Datum rechtsboven
    doc.setFontSize(12);
    doc.text(`Datum: ${new Date().toLocaleDateString()}`,150,15);

    // Overzicht aantal elementen
    const mapping = {"Raam":"Ramen","Deur":"Deuren","Poort":"Poorten"};
    let yEl=100;
    Object.keys(mapping).forEach(t=>{
        const aantal = project.elementen.filter(e=>e.type===t).length;
        if(aantal>0){
            doc.text(`${mapping[t]}: ${aantal}`,105,yEl,{align:"center"});
            yEl+=8;
        }
    });

   // Extra logo's onder datum
// Extra logo's onder datum (dubbel zo groot)
const logoRey = await loadImagePromise('reynaers.png');
const logoGea = await loadImagePromise('gealan.png');

// Dubbele grootte
const logoMaxW = 70;
const logoMaxH = 70;

// Reynaers
let ratioR = logoRey.width / logoRey.height;
let wR = logoMaxW, hR = logoMaxH;

if (ratioR > 1) {
    hR = logoMaxW / ratioR;
} else {
    wR = logoMaxH * ratioR;
}

doc.addImage(logoRey, 'PNG', 135, 25, wR, hR);

// Gealan
let ratioG = logoGea.width / logoGea.height;
let wG = logoMaxW, hG = logoMaxH;

if (ratioG > 1) {
    hG = logoMaxW / ratioG;
} else {
    wG = logoMaxH * ratioG;
}

doc.addImage(logoGea, 'PNG', 135, 25 + hR + 5, wG, hG);

    
    let ratioR=logoRey.width/logoRey.height;
    let wR=logoMaxW,hR=logoMaxH;
    if(ratioR>1){hR=logoMaxW/ratioR;}else{wR=logoMaxH*ratioR;}
    doc.addImage(logoRey,'PNG',150,25,wR,hR);
    let ratioG=logoGea.width/logoGea.height;
    let wG=logoMaxW,hG=logoMaxH;
    if(ratioG>1){hG=logoMaxW/ratioG;}else{wG=logoMaxH*ratioG;}
    doc.addImage(logoGea,'PNG',150,25+hR+2,wG,hG);

    doc.addPage();
    let y=20;
    let pageNumber=1;
    const header=()=>{
        doc.setFontSize(12); doc.setTextColor(0);
        doc.text(`Nieuwe Opmeting: ${project.klant}`,15,10);
        doc.text(`Datum: ${new Date().toLocaleDateString()}`,150,10);
        y=20;
    };
    header();

    for(const el of project.elementen.slice().reverse()){
        // Controle of element past
        let maxFotoH=50;
        let fotos=await Promise.all(fotosMemory[el.id].map(f=>loadImagePromise(f)));
        let fotoRowHeight=maxFotoH;
        if(y+fotoRowHeight+30>280){doc.addPage();pageNumber++;header();}
        // Scheidingslijn
        doc.setDrawColor(0); doc.setLineWidth(0.5); doc.line(10,y,200,y); y+=5;

        const nummer=el.type+" "+(()=>{let count=0;for(const e of project.elementen){if(e.type===el.type && project.elementen.indexOf(e)<=project.elementen.indexOf(el)) count++;} return count;})();
        doc.setFontSize(14); doc.text(`${nummer} - ${el.kamer}`,15,y); y+=7;

        // Foto's en tekst naast elkaar
        let fotoX=15;
        let textY=y;
        const margin=5;
        for(const fImg of fotos){
            let w=fImg.width, h=fImg.height;
            const ratio=w/h;
            if(w>h){if(w>maxFotoH){w=maxFotoH;h=maxFotoH/ratio;}}else{if(h>maxFotoH){h=maxFotoH;w=maxFotoH*ratio;}}
            if(fotoX+w>200){fotoX=15;textY+=fotoRowHeight+margin;}
            doc.addImage(fImg,'JPEG',fotoX,textY,w,h);
            fotoX+=w+margin;
        }
        // Tekst rechts van foto of onder indien geen ruimte
        let textX=fotoX<120?fotoX:15; 
        let textYPos=fotoX<120?textY: textY+fotoRowHeight+margin;
        let textLine=7;
        if(el.breedte) doc.text(`Breedte: ${el.breedte} cm`,textX,textYPos);
        if(el.hoogte) doc.text(`Hoogte: ${el.hoogte} cm`,textX,textYPos+textLine);
        if(el.notitie) doc.text(`Notitie: ${el.notitie}`,textX,textYPos+textLine*2);

        y = Math.max(textYPos+3*textLine, textY+fotoRowHeight)+10;
    }

    // Footer
    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text(`Pagina ${pageNumber}`,105,290,{align:"center"});
    doc.text("Leopoldlaan 91 9900 Eeklo - Tel 09/343.82.70 - info@ramen-blondeel.be",105,295,{align:"center"});

    const fileName=`${project.klant.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(fileName);
    pdfGemaakt=true;
    document.getElementById("mailBtn").disabled=false;
    alert("PDF opgeslagen. Nu kan je project mailen.");
}

function mailProject(){ 
    if(!pdfGemaakt){ alert("Maak eerst de PDF."); return;}
    const subject=encodeURIComponent(`Nieuwe Opmeting: ${project.klant}`);
    const body=encodeURIComponent(`Zie bijlage voor het project: ${project.klant}`);
    window.location.href=`mailto:?subject=${subject}&body=${body}`;
}

document.getElementById("klant").addEventListener("input",e=>{ project.klant=e.target.value; saveMetadata();});
render();
</script>
</body>
</html>



