<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Opmeet Tool</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
html { font-size:32px; }
body { font-family: Arial, sans-serif; background:#f4f6f8; max-width:1100px; margin:auto; padding:16px; }
h1 { text-align:center; font-size:2.4rem; margin-top:10px; }
.card, .element { background:#fff; border-radius:14px; padding:18px; margin-bottom:20px; box-shadow:0 3px 8px rgba(0,0,0,.15); }
label { font-weight:bold; display:block; margin-top:14px; }
input, select { width:100%; font-size:1.6rem; padding:14px; margin-top:6px; }
.element-header { display:flex; justify-content:space-between; align-items:center; }
.remove-element { width:40px; height:40px; background:red; color:white; font-size:22px; border:none; border-radius:6px; cursor:pointer; }
.photo-box { margin-top:16px; padding:16px; border:3px dashed #bbb; border-radius:14px; text-align:center; }
.camera-btn { font-size:90px; cursor:pointer; }
.photo-wrapper { position:relative; margin-top:14px; }
.photo-wrapper img { width:100%; border-radius:10px; }
.remove-photo { position:absolute; top:4px; right:4px; width:32px; height:32px; background:red; color:white; font-size:20px; border:none; border-radius:4px; cursor:pointer; }
button { width:100%; padding:20px; font-size:1.8rem; border:none; border-radius:14px; margin-top:10px; cursor:pointer; }
.primary { background:#2c7be5; color:white; }
.mail-btn { background:#6c757d; color:white; }
.new-project { background:green; color:white; font-size:2rem; }
.add-options { display:flex; gap:10px; }
.add-options button { flex:1; }
.actions { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:14px; }
</style>
</head>
<body>

<div style="text-align:center; margin-bottom:10px;">
  <img src="Logordb.png" alt="Logo" style="max-width:220px; width:60%; height:auto;">
</div>

<h1>Opmeet Tool</h1>

<div class="card">
  <label>Klantnaam</label>
  <input id="clientName">
  <label>Datum</label>
  <input type="date" id="projectDate">
  <label>Klantenhistoriek</label>
  <select id="clientHistory"><option value="">-- Kies klant --</option></select>
</div>

<div id="elements"></div>

<div id="bottomAdd" class="card">
  <button class="primary" onclick="toggleOptions()">+ Element toevoegen</button>
  <div class="add-options" id="optionsBottom" style="display:none">
    <button onclick="addElement('Raam')">Raam</button>
    <button onclick="addElement('Deur')">Deur</button>
    <button onclick="addElement('Poort')">Poort</button>
  </div>
</div>

<div class="card">
  <div class="actions">
    <button class="primary" onclick="exportPDF()">üíæ Opslaan</button>
    <button class="mail-btn" onclick="openMail()">‚úâÔ∏è Mail</button>
  </div>
  <button class="new-project" onclick="newProject()">‚ûï Nieuw project</button>
</div>

<script>
const container=document.getElementById("elements");
const counters={Raam:0,Deur:0,Poort:0};
const clientName=document.getElementById("clientName");
const projectDate=document.getElementById("projectDate");
const clientHistory=document.getElementById("clientHistory");

function toggleOptions(){ const o=document.getElementById("optionsBottom"); o.style.display=o.style.display==="flex"?"none":"flex"; }

function addElement(type, preloadPhotos=[]){
  counters[type]++;
  const el=document.createElement("div");
  el.className="element";
  el.innerHTML=`
    <div class="element-header">
      <strong>${type} ${counters[type]}</strong>
      <button class="remove-element">‚úñ</button>
    </div>
    <label>Breedte (cm)</label>
    <input type="number">
    <label>Hoogte (cm)</label>
    <input type="number">
    <div class="photo-box">
      <div class="camera-btn">üì∑</div>
      <input type="file" accept="image/*" capture hidden>
      <div class="photos"></div>
    </div>`;
  container.appendChild(el);
  el.scrollIntoView({behavior:"smooth", block:"start"});

  const removeEl=el.querySelector(".remove-element");
  removeEl.onclick=()=>{ el.remove(); renumberElements(); autosave(); };

  const inputs=el.querySelectorAll("input[type=number]");
  inputs.forEach(i=>i.oninput=autosave);

  const cam=el.querySelector(".camera-btn");
  const file=el.querySelector("input[type=file]");
  const photos=el.querySelector(".photos");
  cam.onclick=()=>file.click();
  file.onchange=()=>{
    const r=new FileReader();
    r.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const c=document.createElement("canvas");
        const s=Math.min(800/img.width,1);
        c.width=img.width*s; c.height=img.height*s;
        c.getContext("2d").drawImage(img,0,0,c.width,c.height);
        const wrap=document.createElement("div");
        wrap.className="photo-wrapper";
        wrap.innerHTML=`<img src="${c.toDataURL("image/jpeg",0.6)}"><button class="remove-photo">‚úñ</button>`;
        wrap.querySelector("button").onclick=()=>{ wrap.remove(); autosave(); };
        photos.appendChild(wrap);
        autosave();
      }; img.src=e.target.result;
    }; r.readAsDataURL(file.files[0]);
  };

  // Preload foto's bij restore
  preloadPhotos.forEach(src=>{
    const wrap=document.createElement("div");
    wrap.className="photo-wrapper";
    wrap.innerHTML=`<img src="${src}"><button class="remove-photo">‚úñ</button>`;
    wrap.querySelector("button").onclick=()=>{ wrap.remove(); autosave(); };
    photos.appendChild(wrap);
  });

  autosave();
}

function renumberElements(){
  ["Raam","Deur","Poort"].forEach(type=>{
    let i=0;
    container.querySelectorAll(".element").forEach(el=>{
      const s=el.querySelector("strong");
      if(s.textContent.startsWith(type)){ i++; s.textContent=`${type} ${i}`; }
    });
    counters[type]=i;
  });
}

function autosave(){
  const data={klant:clientName.value,datum:projectDate.value,elementen:[]};
  container.querySelectorAll(".element").forEach(el=>{
    data.elementen.push({
      titel:el.querySelector("strong").innerText,
      b:el.querySelectorAll("input")[0].value,
      h:el.querySelectorAll("input")[1].value,
      fotos:[...el.querySelectorAll(".photo-wrapper img")].map(i=>i.src)
    });
  });
  if(clientName.value) localStorage.setItem(clientName.value,JSON.stringify(data));
  localStorage.setItem("autosave",JSON.stringify(data));
  updateClientHistory();
}

function updateClientHistory(){
  const keys=[];
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k!=="autosave") keys.push(k);
  }
  keys.sort();
  while(keys.length>20) localStorage.removeItem(keys.shift());
  clientHistory.innerHTML='<option value="">-- Kies klant --</option>';
  keys.forEach(k=>clientHistory.innerHTML+=`<option>${k}</option>`);
}

clientHistory.onchange=()=>{
  const d=JSON.parse(localStorage.getItem(clientHistory.value));
  if(!d) return;
  container.innerHTML="";
  clientName.value=d.klant;
  projectDate.value=d.datum;
  d.elementen.forEach(e=>{
    addElement(e.titel.split(" ")[0], e.fotos);
    const el=container.lastChild;
    el.querySelectorAll("input")[0].value=e.b;
    el.querySelectorAll("input")[1].value=e.h;
  });
  renumberElements();
}

function newProject(){ if(confirm("Nieuw project starten?")){ localStorage.removeItem("autosave"); location.reload(); } }

function openMail(){
  if(!clientName.value){ alert("Vul eerst een klantnaam in."); return; }
  const subject=encodeURIComponent(`Opmeting - ${clientName.value}`);
  const body=encodeURIComponent(`Beste,\n\nIn bijlage vindt u de opmeting voor ${clientName.value}.\n\nMet vriendelijke groeten`);
  window.location.href=`mailto:?subject=${subject}&body=${body}`;
}

function loadLogoBase64(callback){
  const img=new Image();
  img.onload=function(){ const c=document.createElement("canvas"); c.width=img.width; c.height=img.height; c.getContext("2d").drawImage(img,0,0); callback(c.toDataURL("image/png")); };
  img.src="Logordb.png";
}

function exportPDF(){
  loadLogoBase64(function(logo){
    const { jsPDF }=window.jspdf;
    const pdf=new jsPDF("p","mm","a4");
    const margin=15;
    const pageHeight=297;
    let y=20;

    // Logo
    const logoImg=new Image();
    logoImg.onload=function(){
      const maxLogoWidth=40;
      const ratio=logoImg.height/logoImg.width;
      const logoHeight=maxLogoWidth*ratio;
      pdf.addImage(logo,"PNG",margin,y-10,maxLogoWidth,logoHeight);
      pdf.setFontSize(18); pdf.text("Opmetingsrapport",margin+50,y); y+=12;
      pdf.setFontSize(12); pdf.text(`Klant: ${clientName.value}`,margin,y); y+=6;
      pdf.text(`Datum: ${projectDate.value}`,margin,y); y+=10;

      container.querySelectorAll(".element").forEach(el=>{
        if(y>pageHeight-45){ pdf.addPage(); y=20; }
        pdf.setFontSize(14); pdf.text(el.querySelector("strong").innerText,margin,y); y+=6;
        pdf.setFontSize(12); const i=el.querySelectorAll("input");
        pdf.text(`Breedte: ${i[0].value} cm`,margin,y); y+=5;
        pdf.text(`Hoogte: ${i[1].value} cm`,margin,y); y+=6;

        el.querySelectorAll(".photo-wrapper img").forEach(imgEl=>{
          if(y>pageHeight-50){ pdf.addPage(); y=20; }
          const img=new Image(); img.src=imgEl.src;
          const maxWidth=60,maxHeight=40;
          const ratio=img.height/img.width;
          let w=maxWidth,h=w*ratio;
          if(h>maxHeight){ h=maxHeight; w=h/ratio; }
          pdf.addImage(img.src,"JPEG",margin,y,w,h);
          y+=h+5;
        });
        y+=4;
      });
      pdf.save(`Opmeting - ${clientName.value}.pdf`);
    };
    logoImg.src=logo;
  });
}

/* HERSTEL BIJ REFRESH */
(function(){
  const s=localStorage.getItem("autosave"); if(!s) return;
  const d=JSON.parse(s);
  clientName.value=d.klant; projectDate.value=d.datum; container.innerHTML="";
  d.elementen.forEach(e=>{
    addElement(e.titel.split(" ")[0], e.fotos);
    const el=container.lastChild;
    el.querySelectorAll("input")[0].value=e.b;
    el.querySelectorAll("input")[1].value=e.h;
  });
  renumberElements();
})();
updateClientHistory();
</script>

</body>
</html>
