<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Opmeting PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial,sans-serif; padding:1rem; background:#f4f4f4; }
h1 { display:flex; justify-content:space-between; align-items:center; }
.card { background:white; padding:1rem; border-radius:6px; margin-bottom:1rem; }
label { display:block; margin-top:.5rem; }
input, select, button { width:100%; padding:.5rem; margin-top:.25rem; }
button { cursor:pointer; }
.element { border:1px solid #ddd; padding:.75rem; border-radius:4px; margin-top:.75rem; }
.fotos { display:grid; grid-template-columns: repeat(auto-fill,minmax(100px,1fr)); gap:.5rem; margin-top:.75rem; }
.foto { position:relative; }
.foto img { width:100%; border-radius:4px; border:1px solid #ccc; }
.foto button { position:absolute; top:2px; right:2px; background:#d9534f; color:white; border:none; border-radius:50%; width:24px; height:24px; font-weight:bold; cursor:pointer; }
.remove { background:#d9534f; color:white; border:none; margin-top:.75rem; }
.new-project { background:#0275d8; color:white; border:none; padding:.5rem 1rem; border-radius:4px; }
canvas { display:none; }
video { width:100%; max-height:300px; border-radius:6px; margin-top:.5rem; }
</style>
</head>
<body>

<h1>
  Opmeting PWA
  <button class="new-project" onclick="newProject()">Nieuw project</button>
</h1>

<div class="card">
  <label>Klantnaam</label>
  <input id="klantNaam" placeholder="Naam klant">
</div>

<div class="card">
  <label>Nieuw element</label>
  <select id="elementType">
    <option value="raam">Raam</option>
    <option value="deur">Deur</option>
    <option value="poort">Poort</option>
  </select>
  <button onclick="addElement()">Toevoegen</button>
</div>

<div id="elementen"></div>

<!-- Camera modal -->
<div id="cameraModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);justify-content:center;align-items:center;flex-direction:column;z-index:9999;">
  <video id="video" autoplay></video>
  <button onclick="takePhoto()" style="margin-top:1rem;padding:.5rem 1rem;">Foto maken</button>
  <button onclick="closeCamera()" style="margin-top:.5rem;padding:.5rem 1rem;">Annuleren</button>
</div>

<canvas id="canvas"></canvas>

<script>
/* ===== DATA ===== */
const STORAGE_KEY = "opmeting_pwa";
let project = { klantNaam:"", elementen:[] };
let currentElementId = null;
let stream = null;

/* ===== STORAGE ===== */
function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(project)); }
function load() { const d=localStorage.getItem(STORAGE_KEY); if(d) project=JSON.parse(d); }

/* ===== HELPERS ===== */
function uuid() { return crypto.randomUUID(); }

/* ===== ELEMENTEN ===== */
function addElement() {
  project.elementen.push({id:uuid(),type:elementType.value,breedte:"",hoogte:"",fotos:[]});
  save(); render();
}
function removeElement(id) { project.elementen = project.elementen.filter(e=>e.id!==id); save(); render(); }
function updateValue(id,field,value) { project.elementen.find(e=>e.id===id)[field]=value; save(); }

/* ===== CAMERA ===== */
function openCamera(elementId){
  currentElementId = elementId;
  document.getElementById('cameraModal').style.display='flex';
  const video = document.getElementById('video');
  navigator.mediaDevices.getUserMedia({ video:true })
    .then(s => { stream=s; video.srcObject=stream; })
    .catch(err=>{ alert("Camera niet beschikbaar: "+err); closeCamera(); });
}
function closeCamera(){
  document.getElementById('cameraModal').style.display='none';
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
}
function takePhoto(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0,canvas.width,canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg',0.7);
  project.elementen.find(e=>e.id===currentElementId).fotos.push(dataUrl);
  save(); render(); closeCamera();
}

/* ===== NIEUW PROJECT ===== */
function newProject(){
  if(!confirm("Nieuw project starten? Alles wordt gewist.")) return;
  localStorage.removeItem(STORAGE_KEY);
  project={ klantNaam:"",elementen:[] };
  render();
}

/* ===== RENDER ===== */
function render(){
  klantNaam.value = project.klantNaam;
  const c=document.getElementById("elementen");
  c.innerHTML="";
  ["raam","deur","poort"].forEach(type=>{
    project.elementen.filter(e=>e.type===type).forEach((el,i)=>{
      const d=document.createElement("div");
      d.className="card element";
      d.innerHTML=`
        <strong>${type[0].toUpperCase()+type.slice(1)} ${i+1}</strong>
        <label>Breedte (mm)</label>
        <input type="number" value="${el.breedte}" oninput="updateValue('${el.id}','breedte',this.value)">
        <label>Hoogte (mm)</label>
        <input type="number" value="${el.hoogte}" oninput="updateValue('${el.id}','hoogte',this.value)">
        <button onclick="openCamera('${el.id}')">Camera openen</button>
        <div class="fotos">
          ${el.fotos.map((f,idx)=>`
            <div class="foto">
              <img src="${f}">
              <button onclick="project.elementen.find(e=>e.id==='${el.id}').fotos.splice(${idx},1); save(); render();">Ã—</button>
            </div>`).join("")}
        </div>
        <button class="remove" onclick="removeElement('${el.id}')">Element verwijderen</button>
      `;
      c.appendChild(d);
    });
  });
}

/* ===== INIT ===== */
klantNaam.addEventListener("input", e=>{project.klantNaam=e.target.value; save();});
load(); render();
</script>

</body>
</html>
