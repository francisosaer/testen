<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nieuwe Opmeting</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family:Arial;
    margin:20px;
}
button{
    padding:10px 15px;
    margin:5px 0;
    font-size:15px;
    cursor:pointer;
}
input, textarea{
    width:100%;
    padding:6px;
    margin-bottom:8px;
}
.foto{
    width:80px;
    margin:5px;
}
.element{
    border:1px solid #ccc;
    padding:10px;
    margin-top:15px;
}
</style>
</head>

<body>

<h2>Nieuwe Opmeting</h2>

<label>Klantnaam</label>
<input id="klant">

<button onclick="nieuwElement()">Nieuw Element</button>

<div id="elementen"></div>

<hr>

<button onclick="downloadPDF()">Download PDF</button>
<button onclick="mailProject()">Mail project</button>

<script>

let project={
    klant:"",
    elementen:[]
};

let fotosMemory={};
let teller=1;

function nieuwElement(){

    const id=Date.now();

    const element={
        id:id,
        nummer:teller++,
        kamer:"",
        breedte:"",
        hoogte:"",
        notitie:""
    };

    project.elementen.push(element);
    fotosMemory[id]=[];

    render();
}

function render(){

    const container=document.getElementById("elementen");
    container.innerHTML="";

    project.klant=document.getElementById("klant").value;

    project.elementen.forEach(el=>{

        const div=document.createElement("div");
        div.className="element";

        div.innerHTML=`
        <b>Element ${el.nummer}</b><br>
        Kamer:<input onchange="update(${el.id},'kamer',this.value)">
        Breedte (cm):<input onchange="update(${el.id},'breedte',this.value)">
        Hoogte (cm):<input onchange="update(${el.id},'hoogte',this.value)">
        Notitie:<textarea onchange="update(${el.id},'notitie',this.value)"></textarea>
        <button onclick="neemFoto(${el.id})">Foto nemen</button>
        <div id="fotos-${el.id}"></div>
        `;

        container.appendChild(div);
        toonFotos(el.id);
    });
}

function update(id,veld,waarde){
    const el=project.elementen.find(e=>e.id===id);
    el[veld]=waarde;
}

function neemFoto(id){

    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";

    input.onchange=function(e){
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=function(evt){
            fotosMemory[id].push(evt.target.result);
            toonFotos(id);
        };
        reader.readAsDataURL(file);
    };

    input.click();
}

function toonFotos(id){

    const div=document.getElementById("fotos-"+id);
    div.innerHTML="";

    fotosMemory[id].forEach(f=>{
        const img=document.createElement("img");
        img.src=f;
        img.className="foto";
        div.appendChild(img);
    });
}

function downloadPDF(){

    if(project.elementen.length===0){
        alert("Geen elementen toegevoegd.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();

    let y=20;
    const marge=15;
    const breedte=doc.internal.pageSize.getWidth();
    const hoogte=doc.internal.pageSize.getHeight();

    const datum=new Date().toLocaleDateString("nl-BE");
    const klant=document.getElementById("klant").value||"Project";

    doc.setFontSize(16);
    doc.text("Opmeting - "+klant,breedte/2,15,{align:"center"});

    doc.setFontSize(10);
    doc.text("Datum: "+datum,breedte-15,15,{align:"right"});

    y=25;

    project.elementen.forEach(el=>{

        if(y>hoogte-40){doc.addPage();y=20;}

        doc.setFontSize(12);
        doc.text("Element "+el.nummer+" ("+el.kamer+")",marge,y);
        y+=7;

        doc.setFontSize(10);
        doc.text("Breedte: "+(el.breedte||"-")+" cm",marge,y); y+=6;
        doc.text("Hoogte: "+(el.hoogte||"-")+" cm",marge,y); y+=6;
        if(el.notitie){
            doc.text("Notitie: "+el.notitie,marge,y);
            y+=6;
        }

        y+=5;

        let x=marge;

        fotosMemory[el.id].forEach(foto=>{

            if(y>hoogte-50){
                doc.addPage();
                y=20;
                x=marge;
            }

            doc.addImage(foto,"JPEG",x,y,40,30);
            x+=50;

            if(x>breedte-50){
                x=marge;
                y+=40;
            }
        });

        y+=45;
    });

    const bestandsnaam=
        "Opmeting_"+klant.replace(/ /g,"_")+"_"+datum.replace(/\//g,"-")+".pdf";

    doc.save(bestandsnaam);
}

function mailProject(){

    const klant=document.getElementById("klant").value||"Project";
    const onderwerp=encodeURIComponent("Opmeting - "+klant);

    const body=encodeURIComponent(
`Beste,

In bijlage vindt u de opmeting in PDF.

Gelieve de zojuist gedownloade PDF toe te voegen als bijlage.

Met vriendelijke groeten`
    );

    window.location.href=`mailto:?subject=${onderwerp}&body=${body}`;
}

document.getElementById("klant").addEventListener("input",render);

</script>

</body>
</html>
