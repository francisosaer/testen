<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nieuwe Opmeting</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
    font-family:Arial;
    margin:20px;
    background:#f4f6f9;
}
header{
    display:flex;
    align-items:center;
    gap:15px;
}
header img{
    height:60px;
}
h2{
    color:#0f2441;
}
button{
    padding:10px 16px;
    margin:5px 5px 5px 0;
    font-size:14px;
    cursor:pointer;
    border:none;
    border-radius:6px;
}
.btn-blauw{background:#0f2441;color:white;}
.btn-groen{background:#1a7f37;color:white;}
.btn-rood{background:#b00020;color:white;}

input, select, textarea{
    width:100%;
    padding:6px;
    margin-bottom:8px;
    border:1px solid #ccc;
    border-radius:4px;
}

.element{
    background:white;
    padding:12px;
    margin-top:15px;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.05);
}

.foto{
    width:90px;
    margin:5px;
    border-radius:6px;
}
</style>
</head>

<body>

<header>
    <img src="logo.png" alt="Logo">
    <h2>Nieuwe Opmeting</h2>
</header>

<br>

<label>Klantnaam</label>
<input id="klant">

<button class="btn-rood" onclick="nieuwProject()">Nieuw Project</button>
<button class="btn-blauw" onclick="nieuwElement()">Nieuw Element</button>

<div id="elementen"></div>

<hr>

<button class="btn-blauw" onclick="downloadPDF()">Download PDF</button>
<button class="btn-groen" onclick="mailProject()">Mail project</button>

<script>

let project={
    klant:"",
    elementen:[]
};

let fotosMemory={};
let teller=1;

function nieuwProject(){
    if(confirm("Nieuw project starten? Huidige gegevens gaan verloren.")){
        project={klant:"",elementen:[]};
        fotosMemory={};
        teller=1;
        document.getElementById("klant").value="";
        render();
    }
}

function nieuwElement(){

    const id=Date.now();

    const element={
        id:id,
        nummer:teller++,
        kamer:"",
        breedte:"",
        hoogte:"",
        notitie:""
    };

    project.elementen.push(element);
    fotosMemory[id]=[];

    render();
}

function render(){

    const container=document.getElementById("elementen");
    container.innerHTML="";

    project.klant=document.getElementById("klant").value;

    project.elementen.forEach(el=>{

        const div=document.createElement("div");
        div.className="element";

        div.innerHTML=`
        <b>Element ${el.nummer}</b><br><br>

        Kamer:
        <select onchange="update(${el.id},'kamer',this.value)">
            <option value="">-- Kies kamer --</option>
            <option>Living</option>
            <option>Keuken</option>
            <option>Badkamer</option>
            <option>Slaapkamer</option>
            <option>Bureau</option>
            <option>Anders</option>
        </select>

        Breedte (cm):
        <input onchange="update(${el.id},'breedte',this.value)">

        Hoogte (cm):
        <input onchange="update(${el.id},'hoogte',this.value)">

        Notitie:
        <textarea onchange="update(${el.id},'notitie',this.value)"></textarea>

        <button class="btn-blauw" onclick="neemFoto(${el.id})">Foto nemen</button>

        <div id="fotos-${el.id}"></div>
        `;

        container.appendChild(div);
        toonFotos(el.id);
    });
}

function update(id,veld,waarde){
    const el=project.elementen.find(e=>e.id===id);
    el[veld]=waarde;
}

function neemFoto(id){

    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.capture="environment";

    input.onchange=function(e){
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=function(evt){
            fotosMemory[id].push(evt.target.result);
            toonFotos(id);
        };
        reader.readAsDataURL(file);
    };

    input.click();
}

function toonFotos(id){

    const div=document.getElementById("fotos-"+id);
    div.innerHTML="";

    fotosMemory[id].forEach(f=>{
        const img=document.createElement("img");
        img.src=f;
        img.className="foto";
        div.appendChild(img);
    });
}

function downloadPDF(){

    if(project.elementen.length===0){
        alert("Geen elementen toegevoegd.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const doc=new jsPDF();

    const marge=15;
    const breedte=doc.internal.pageSize.getWidth();
    const hoogte=doc.internal.pageSize.getHeight();
    let y=30;

    const datum=new Date().toLocaleDateString("nl-BE");
    const klant=document.getElementById("klant").value||"Project";

    doc.setFontSize(18);
    doc.setTextColor(15,36,65);
    doc.text("Opmeting - "+klant,breedte/2,20,{align:"center"});

    doc.setFontSize(10);
    doc.setTextColor(100);
    doc.text("Datum: "+datum,breedte-15,20,{align:"right"});

    doc.setDrawColor(15,36,65);
    doc.line(marge,25,breedte-marge,25);

    project.elementen.forEach(el=>{

        if(y>hoogte-50){doc.addPage();y=30;}

        doc.setFontSize(12);
        doc.setTextColor(15,36,65);
        doc.text("Element "+el.nummer+" - "+(el.kamer||""),marge,y);
        y+=8;

        doc.setFontSize(10);
        doc.setTextColor(0);
        doc.text("Breedte: "+(el.breedte||"-")+" cm",marge,y); y+=6;
        doc.text("Hoogte: "+(el.hoogte||"-")+" cm",marge,y); y+=6;

        if(el.notitie){
            doc.text("Notitie: "+el.notitie,marge,y);
            y+=6;
        }

        y+=8;

        let x=marge;

        fotosMemory[el.id].forEach(foto=>{

            if(y>hoogte-60){
                doc.addPage();
                y=30;
                x=marge;
            }

            doc.addImage(foto,"JPEG",x,y,45,35);
            x+=55;

            if(x>breedte-55){
                x=marge;
                y+=45;
            }
        });

        y+=50;
    });

    const bestandsnaam=
        "Opmeting_"+klant.replace(/ /g,"_")+"_"+datum.replace(/\//g,"-")+".pdf";

    doc.save(bestandsnaam);
}

function mailProject(){

    const klant=document.getElementById("klant").value||"Project";
    const onderwerp=encodeURIComponent("Opmeting - "+klant);

    const body=encodeURIComponent(
`Beste,

In bijlage vindt u de opmeting in PDF.

Gelieve de gedownloade PDF toe te voegen als bijlage.

Met vriendelijke groeten`
    );

    window.location.href=`mailto:?subject=${onderwerp}&body=${body}`;
}

document.getElementById("klant").addEventListener("input",render);

</script>

</body>
</html>
